<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<style type="text/css">


/* On mouse hover, lighten state color */
/*
path:hover {
	fill-opacity: .7;
}
*/

svg {
  position: relative;
}

/* Style for Custom Tooltip */
div.tooltip {
 	position: absolute;
	text-align: center;
	width: 100px;
	height: auto;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

circle {
  cursor: pointer;
}

/* Legend Font Style */
body {
	font: 11px sans-serif;
}

.hide {
  display: none;
}

</style>
</head>
<body>

<div id="map"></div>
<div id="card">
  <div class="market-category-form">
    <h3 class="header">Filter the map by category</h3>
    <div class="checkbox-wrap">
      <input type="checkbox" id="capitalized" name="feature"
                 value="scales" checked />
      <label for="capitalized">Capitalized</label>
    </div>
    <div class="checkbox-wrap">
      <input type="checkbox" id="opportunity" name="feature"
                 value="scales" checked />
      <label for="opportunity">Opportunity</label>
    </div>
    <div class="checkbox-wrap">
      <input type="checkbox" id="growth" name="feature"
                 value="scales" checked />
      <label for="growth">Growth</label>
    </div>
    <div class="checkbox-wrap">
      <input type="checkbox" id="investment" name="feature"
                 value="scales" checked />
      <label for="investment">Capitalized</label>
    </div>
  </div>
</div>



<script type="text/javascript">

/*  This visualization was made possible by modifying code provided by:

Scott Murray, Choropleth example from "Interactive Data Visualization for the Web"
https://github.com/alignedleft/d3-book/blob/master/chapter_12/05_choropleth.html

Malcolm Maclean, tooltips example tutorial
http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html

Mike Bostock, Pie Chart Legend
http://bl.ocks.org/mbostock/3888852  */


//Width and height of map
var width = 960;
var height = 600;

// dictionary to hold geoid and associated property data
var geoDict = {};

// D3 Projection
var projection = d3.geo.albersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1280]);          // scale things down so see entire US

// Define path generator
var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection


// Define linear scale for output
//var color = d3.scale.linear()
			  //.range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);


//Create SVG element and append map to the SVG
var svg = d3.select("#map")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

// Append Div for tooltip to SVG
var div = d3.select("#map")
		    .append("div")
    		.attr("class", "tooltip")
    		.style("opacity", 0);

// Load GeoJSON for US States
d3.json("us-states.json", function(json) {

  // Bind the data to the SVG and create one path per GeoJSON feature
  svg.selectAll("path")
    .data(json.features)
    .enter()
    .append("path")
    .attr("d", path)
    .style("stroke", "rgb(255,255,255)")
    .style("stroke-width", "0.2")
    .style("fill", "rgb(173,193,200)");
});


// load metro info to a dictionary (to later display in card)
d3.json("metroArea_with_data.json", function(metroData) {

  // set of features to loop through
  var metros = metroData.features;

  // build dictionary of data with geoid as key
  for (var i = 0; i < metros.length; i++) {

  	// Grab State Name
  	var propData = metros[i].properties;

    // get geoid for key in geoDict
    var geoid = propData.GEOID;

    // set geoid key equal to rest of propData
    geoDict[geoid] = propData;
  }
});




// load metro data to display on a map
d3.json("dotMapData_output.json", function(pointData) {

  // make the geoid the class
  svg.selectAll("circle")
  	.data(pointData.features)
  	.enter()
  	.append("circle")
  	.attr("cx", function(d) {
      var lon = d.geometry.coordinates[0];
      var lat = d.geometry.coordinates[1];
      var coord = projection([lon, lat]);
      console.log(d.properties.NAME);
      return coord[0];
  	})
  	.attr("cy", function(d) {
      var lon = d.geometry.coordinates[0];
      var lat = d.geometry.coordinates[1];
      var coord = projection([lon, lat]);
  		return coord[1];
  	})
  	.attr("r", 3)
    .attr('class', function(d) {
      var geoid = d.properties.GEOID;
      var category = d.properties.category;
      var state = d.properties.state;
      var state0 = d.properties.state0;
      var classes = geoid + " " + category + " " + state + " " + state0;
      return classes;
    })
  	.style("fill", function(d) {
      var category = d.properties.category;
      if (category == 'capitalized') {
        return "rgb(230,27,80)";
      }
      else if (category == 'opportunity') {
        return "rgb(252,209,71)";
      }
      else if (category == 'growth') {
        return "rgb(31,31,149)";
      }
      else if (category == 'investment') {
        return "rgb(131,71,157)";
      }
      else {
        return "rgb(0,0,0)";
      }
    })

  	// Modification of custom tooltip code provided by Malcolm Maclean, "D3 Tips and Tricks"
  	// http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html
  	.on("mouseover", function(d) {
      	div.transition()
        	   .duration(200)
             .style("opacity", .95);
             div.text(geoDict[d.properties.GEOID].NAME)
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY - 23) + "px");
  	})

    // fade out tooltip on mouse out
    .on("mouseout", function(d) {
        div.transition()
           .duration(500)
           .style("opacity", 0);
    });
});


jQuery(document).ready( function() {

  // takes a checkbox element object as input
  // adds and removes class on dot (to hide and show element)
  function toggleMarkets(checkbox) {
    var category = checkbox.attr('id');
    var dots = jQuery('circle.' + category);
    if (checkbox.prop('checked') == false) {
      console.log("False");
      dots.addClass('hide');
    }
    else {
      if (dots.hasClass('hide')) {
        dots.removeClass('hide');
      }
    }
  }

  // toggle market category dots on and off
  jQuery('.market-category-form input').on('click', function() {
    var checkbox = jQuery(this);
    toggleMarkets(checkbox);
  });

  // append pin on page load
  jQuery('svg').append('<div class="pin"><i class="fas fa-map-marker-alt"></i></div>');
  var pinPosition = {
      position : "absolute",
      left: "46.79951936128697px",
      top: "320.8902663131511px"
    };
  jQuery('.pin').css(pinPosition);


  // move pin on click
  jQuery('#map circle').on('click', function() {
    var thisDot = jQuery(this);
    var leftPosition = thisDot.attr('cx');
    var topPosition = thisDot.attr('cy');
    var pinPosition = {
      position : "absolute",
      left: leftPosition,
      top: topPosition
    };
    jQuery('.pin').css(pinPosition);
  });


});



</script>
</body>
</html>
